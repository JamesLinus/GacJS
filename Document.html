<!DOCTYPE html>
<html>
<head>
    <title>Document</title>
    <link rel="stylesheet" href="./Doc/Document.css" />
    <link rel="stylesheet" href="./Doc/TreeView.css" />
    <script src="./Script/Package.js"></script>
    <script async src="./Script/Class.js"></script>
    <script async src="./Script/Test.js"></script>
    <script async src="./Script/Html/Navigation.js"></script>
    <script async src="./Script/Html/Razor.js"></script>
    <script async src="./Script/IO/Delay.js"></script>
    <script async src="./Script/IO/Resource.js"></script>
    <script async src="./Script/IO/Wildcard.js"></script>
    <script async src="./Doc/Document.js"></script>
    <script async src="./Doc/TreeView.js"></script>
</head>
<body>
    <table class="DocumentView">
        <tr>
            <td class="DocumentTitle" colspan="2">
                <img src="./Doc/Logo.gif" />
            </td>
        </tr>
        <tr>
            <td class="DocumentIndex" id="documentIndex"></td>
            <td class="DocumentContent" id="documentContent"></td>
        </tr>
    </table>

    <script>
        Packages.Define("Doc.DocumentPage", ["Class", "Doc.Document", "Doc.TreeView", "IO.Resource"], function (__injection__) {
            eval(__injection__);

            rootContainer = new TreeNodeContainer(true, documentIndex, "Loading ./Doc/Data/nss.xml ...");
            keyNodeMap = {};
            nodeLoaded = {};

            // nss.xml
            GetResourceAsync("./Doc/Data/nss.xml", true).SucceededThen(function (result) {
                var nsXmls = result.Xml.firstChild.getElementsByTagName("Namespace");
                for (var i = 0; i < nsXmls.length; i++) {
                    var nsXml = nsXmls[i];
                    var displayName = nsXml.getAttribute("DisplayName").split(" ");
                    var hasDoc = nsXml.getAttribute("Doc") === "true";

                    var urlName = nsXml.getAttribute("UrlName");
                    var indexFile = "./Doc/Data/ns(" + urlName + ").xml";

                    var treeNode = new TreeNode(true, "Loading " + indexFile + " ...");
                    treeNode.Title = displayName[0];
                    treeNode.Postfix = displayName[1];
                    treeNode.HasDoc = hasDoc;
                    rootContainer.AddTreeNode(treeNode);

                    var key = nsXml.getAttribute("Key");
                    keyNodeMap[key] = treeNode;
                    treeNode.ExpandedChanged.Attach((function () {
                        var nsKey = key;
                        var nsIndexFile = indexFile;
                        var nsTreeNode = treeNode;
                        return function () {
                            if (!nodeLoaded.hasOwnProperty(nsKey)) {
                                nodeLoaded[nsKey] = null;

                                // ns(symbol).xml
                                GetResourceAsync(nsIndexFile, true).SucceededThen(function (result) {
                                    var overloadsXmls = result.Xml.firstChild.getElementsByTagName("Overloads");
                                    for (var i = 0; i < overloadsXmls.length; i++) {
                                        var overloadsXml = overloadsXmls[i];
                                        var displayName = overloadsXml.getAttribute("DisplayName").split(" ");
                                        var symbolXmls = overloadsXml.getElementsByTagName("Symbol");
                                        var treeNodes = [];

                                        for (var j = 0; j < symbolXmls.length; j++) {
                                            var symbolXml = symbolXmls[j];
                                            var hasDoc = symbolXml.getAttribute("Doc") === "true";
                                            var hasChildren = displayName[1] === "class" || displayName[1] === "struct" || displayName[1] === "union";

                                            var urlName = symbolXml.getAttribute("UrlName");
                                            var indexFile = "./Doc/Data/t(" + urlName + ").xml";

                                            var treeNode = new TreeNode(hasChildren, "Loading " + indexFile + " ...");
                                            treeNode.Title = displayName[0];
                                            treeNode.Postfix = displayName[1];
                                            treeNode.HasDoc = hasDoc;
                                            treeNodes.push(treeNode);
                                        }

                                        if (treeNodes.length === 1) {
                                            nsTreeNode.AddTreeNode(treeNodes[0]);
                                        }
                                        else {
                                            var treeNode = new TreeNode(true, "");
                                            treeNode.Title = displayName[0];
                                            treeNode.Postfix = displayName[1];
                                            treeNode.HasDoc = treeNodes.filter(function (n) { return n.HasDoc; }).length > 0;
                                            nsTreeNode.AddTreeNode(treeNode);

                                            for (var j = 0; j < treeNodes.length; j++) {
                                                treeNode.AddTreeNode(treeNodes[j]);
                                            }
                                        }
                                    }
                                });
                            }
                        }
                    })());
                }
            });

            return {
            }
        })
    </script>
</body>
</html>
